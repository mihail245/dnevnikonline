<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–µ–±–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫</title>
    <style>
        :root {
            --dark-bg: #121212;
            --dark-card: #1e1e1e;
            --dark-border: #333;
            --dark-text: #e0e0e0;
            --dark-primary: #3a4750;
            --dark-secondary: #303841;
            --dark-accent: #00adb5;
            --dark-hover: #2c3e50;
            --dark-success: #2e7d32;
            --dark-danger: #c62828;
            --dark-gray: #555;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--dark-primary), var(--dark-secondary));
            color: var(--dark-text);
            padding: 1rem 0;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--dark-primary);
            color: var(--dark-text);
        }
        
        .btn-primary:hover {
            background-color: var(--dark-hover);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--dark-text);
            color: var(--dark-text);
        }
        
        .btn-outline:hover {
            background-color: var(--dark-text);
            color: var(--dark-primary);
        }
        
        .btn-success {
            background-color: var(--dark-success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1b5e20;
        }
        
        .btn-danger {
            background-color: var(--dark-danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        
        .btn-accent {
            background-color: var(--dark-accent);
            color: white;
        }
        
        .btn-accent:hover {
            background-color: #0097a7;
        }
        
        main {
            padding: 2rem 0;
        }
        
        .auth-container, .diary-container {
            background-color: var(--dark-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--dark-border);
        }
        
        .diary-container {
            display: none;
        }
        
        h2 {
            margin-bottom: 1.5rem;
            color: var(--dark-accent);
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            background-color: var(--dark-bg);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--dark-accent);
        }
        
        .subject-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 768px) {
            .subject-form {
                grid-template-columns: 1fr;
            }
        }
        
        .subjects-list {
            margin-top: 2rem;
        }
        
        .subject-card {
            background-color: var(--dark-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--dark-accent);
            border: 1px solid var(--dark-border);
        }
        
        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .subject-title {
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .subject-average {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark-accent);
        }
        
        .grades-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .grade-item {
            background-color: var(--dark-primary);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .grade-actions {
            display: flex;
            gap: 5px;
        }
        
        .error-message {
            color: #ef5350;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .success-message {
            color: #4caf50;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-text);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--dark-border);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--dark-text);
            font-weight: 500;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--dark-accent);
            color: var(--dark-accent);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-panel {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--dark-border);
        }
        
        .user-list {
            margin-top: 1rem;
        }
        
        .user-item {
            padding: 1rem;
            background-color: var(--dark-card);
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--dark-border);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .user-item:hover {
            background-color: var(--dark-primary);
        }
        
        .edit-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .edit-input {
            flex: 1;
        }
        
        .small-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">–£—á–µ–±–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫</div>
            <div class="auth-buttons" id="authButtons">
                <button class="btn-outline" id="loginBtn">–í—Ö–æ–¥</button>
                <button class="btn-primary" id="registerBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userEmail"></span>
                <button class="btn-outline" id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="auth-container" id="authContainer">
            <h2 id="authTitle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary" id="authSubmit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </form>
            <div id="authMessage" class="error-message"></div>
        </div>

        <div class="diary-container" id="diaryContainer">
            <div class="tabs">
                <button class="tab active" data-tab="subjects">–ü—Ä–µ–¥–º–µ—Ç—ã</button>
                <button class="tab" data-tab="grades">–û—Ü–µ–Ω–∫–∏</button>
                <button class="tab" data-tab="admin" id="adminTab" style="display: none;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
            </div>
            
            <div class="tab-content active" id="subjectsTab">
                <h2>–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h2>
                <button class="btn-accent" id="addSubjectBtn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                
                <div id="subjectsList" class="subjects-list">
                    <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <div class="tab-content" id="gradesTab">
                <h2>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h2>
                <div id="gradesContent">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ —Å –æ—Ü–µ–Ω–∫–∞–º–∏ -->
                </div>
            </div>
            
            <div class="tab-content" id="adminTabContent">
                <h2>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–Ω–µ–≤–Ω–∏–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
                <div class="admin-panel">
                    <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div id="usersList" class="user-list">
                        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    </div>
                    <div id="selectedUserDiary">
                        <!-- –î–Ω–µ–≤–Ω–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase App (–æ—Å–Ω–æ–≤–Ω–æ–π SDK Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCaNedHxv1aybxGcUR-mU9TkMuLf2toQG4",
            authDomain: "dnevnik-d4846.firebaseapp.com",
            projectId: "dnevnik-d4846",
            storageBucket: "dnevnik-d4846.firebasestorage.app",
            messagingSenderId: "879922990092",
            appId: "1:879922990092:web:78262b08cd5437dbfc3229"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const authContainer = document.getElementById('authContainer');
        const diaryContainer = document.getElementById('diaryContainer');
        const authForm = document.getElementById('authForm');
        const authTitle = document.getElementById('authTitle');
        const authSubmit = document.getElementById('authSubmit');
        const authMessage = document.getElementById('authMessage');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authButtons = document.getElementById('authButtons');
        const userInfo = document.getElementById('userInfo');
        const userEmail = document.getElementById('userEmail');
        const subjectsList = document.getElementById('subjectsList');
        const addSubjectBtn = document.getElementById('addSubjectBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const adminTab = document.getElementById('adminTab');
        const adminTabContent = document.getElementById('adminTabContent');
        const gradesContent = document.getElementById('gradesContent');
        const usersList = document.getElementById('usersList');
        const selectedUserDiary = document.getElementById('selectedUserDiary');

        let isLoginMode = false;
        let currentUser = null;
        let isAdmin = false;

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        loginBtn.addEventListener('click', () => {
            isLoginMode = true;
            authTitle.textContent = '–í—Ö–æ–¥';
            authSubmit.textContent = '–í–æ–π—Ç–∏';
            authMessage.textContent = '';
        });

        registerBtn.addEventListener('click', () => {
            isLoginMode = false;
            authTitle.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            authSubmit.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            authMessage.textContent = '';
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tabId}Tab`).classList.add('active');
                
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ –æ—Ü–µ–Ω–æ–∫, –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ü–µ–Ω–∫–∏
                if (tabId === 'grades') {
                    loadGradesTab();
                }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            authMessage.textContent = '';
            
            if (isLoginMode) {
                // –í—Ö–æ–¥
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                        authMessage.textContent = '';
                    })
                    .catch((error) => {
                        authMessage.textContent = error.message;
                    });
            } else {
                // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        authMessage.textContent = '';
                    })
                    .catch((error) => {
                        authMessage.textContent = error.message;
                    });
            }
        });

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
        addSubjectBtn.addEventListener('click', () => {
            const subjectName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:');
            if (subjectName && currentUser) {
                addNewSubject(currentUser.uid, subjectName);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
        function addNewSubject(userId, subjectName) {
            const subjectRef = db.collection('users').doc(userId).collection('subjects').doc(subjectName);
            
            subjectRef.set({
                name: subjectName,
                grades: [],
                average: 0
            })
            .then(() => {
                loadUserSubjects(userId);
            })
            .catch((error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞: ", error);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ –∫ –ø—Ä–µ–¥–º–µ—Ç—É
        function addGradeToSubject(userId, subjectName, grade) {
            const subjectRef = db.collection('users').doc(userId).collection('subjects').doc(subjectName);
            
            subjectRef.get()
                .then((doc) => {
                    if (doc.exists) {
                        // –ü—Ä–µ–¥–º–µ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                        const data = doc.data();
                        const updatedGrades = [...data.grades, grade];
                        const average = calculateAverage(updatedGrades);
                        
                        subjectRef.update({
                            grades: updatedGrades,
                            average: average
                        });
                    }
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏: ", error);
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
        function updateSubjectName(userId, oldName, newName) {
            const oldRef = db.collection('users').doc(userId).collection('subjects').doc(oldName);
            const newRef = db.collection('users').doc(userId).collection('subjects').doc(newName);
            
            oldRef.get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        newRef.set(data);
                        oldRef.delete();
                        loadUserSubjects(userId);
                    }
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞: ", error);
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏
        function updateGrade(userId, subjectName, gradeIndex, newGrade) {
            const subjectRef = db.collection('users').doc(userId).collection('subjects').doc(subjectName);
            
            subjectRef.get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        const updatedGrades = [...data.grades];
                        updatedGrades[gradeIndex] = newGrade;
                        const average = calculateAverage(updatedGrades);
                        
                        subjectRef.update({
                            grades: updatedGrades,
                            average: average
                        });
                    }
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏: ", error);
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏
        function deleteGrade(userId, subjectName, gradeIndex) {
            const subjectRef = db.collection('users').doc(userId).collection('subjects').doc(subjectName);
            
            subjectRef.get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        const updatedGrades = [...data.grades];
                        updatedGrades.splice(gradeIndex, 1);
                        const average = calculateAverage(updatedGrades);
                        
                        subjectRef.update({
                            grades: updatedGrades,
                            average: average
                        });
                    }
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏: ", error);
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ
        function calculateAverage(grades) {
            if (grades.length === 0) return 0;
            const sum = grades.reduce((total, grade) => total + grade, 0);
            return sum / grades.length;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserSubjects(userId) {
            subjectsList.innerHTML = '';
            
            db.collection('users').doc(userId).collection('subjects')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        subjectsList.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç!</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const subject = doc.data();
                        renderSubject(subject);
                    });
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: ", error);
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∫–ª–∞–¥–∫–∏ —Å –æ—Ü–µ–Ω–∫–∞–º–∏
        function loadGradesTab() {
            gradesContent.innerHTML = '';
            
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).collection('subjects')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        gradesContent.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç!</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const subject = doc.data();
                        renderSubjectGrades(subject);
                    });
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: ", error);
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
        function renderSubject(subject) {
            const subjectElement = document.createElement('div');
            subjectElement.className = 'subject-card';
            subjectElement.innerHTML = `
                <div class="subject-header">
                    <div class="subject-title">${subject.name}</div>
                    <div class="subject-average">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${subject.average.toFixed(2)}</div>
                </div>
                <div class="grades-list">
                    ${subject.grades.map((grade, index) => 
                        `<span class="grade-item">${grade}</span>`
                    ).join('')}
                </div>
                <button class="btn-accent small-btn" style="margin-top: 10px;" onclick="promptAddGrade('${subject.name}')">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
            `;
            
            subjectsList.appendChild(subjectElement);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –æ—Ü–µ–Ω–æ–∫
        function renderSubjectGrades(subject) {
            const subjectElement = document.createElement('div');
            subjectElement.className = 'subject-card';
            
            const gradesHtml = subject.grades.map((grade, index) => 
                `<span class="grade-item">
                    ${grade}
                    <button class="small-btn" onclick="promptEditGrade('${subject.name}', ${index}, ${grade})">‚úèÔ∏è</button>
                    <button class="small-btn btn-danger" onclick="deleteGrade('${currentUser.uid}', '${subject.name}', ${index})">üóëÔ∏è</button>
                </span>`
            ).join('');
            
            subjectElement.innerHTML = `
                <div class="subject-header">
                    <div class="subject-title">
                        ${subject.name}
                        <button class="small-btn" onclick="promptRenameSubject('${subject.name}')">‚úèÔ∏è</button>
                    </div>
                    <div class="subject-average">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${subject.average.toFixed(2)}</div>
                </div>
                <div class="grades-list">${gradesHtml}</div>
                <div style="margin-top: 10px;">
                    <button class="btn-accent small-btn" onclick="promptAddGrade('${subject.name}')">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
                </div>
            `;
            
            gradesContent.appendChild(subjectElement);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –∞–¥–º–∏–Ω–∞)
        function loadUsersList() {
            usersList.innerHTML = '';
            
            db.collection('users').get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const userId = doc.id;
                        // –ü–æ–ª—É—á–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ auth (—ç—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å email –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        renderUserItem(userId);
                    });
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ", error);
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ
        function renderUserItem(userId) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            // –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º userId –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
            const userElement = document.createElement('div');
            userElement.className = 'user-item';
            userElement.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}`;
            userElement.onclick = () => loadUserDiary(userId);
            
            usersList.appendChild(userElement);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserDiary(userId) {
            selectedUserDiary.innerHTML = '<h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3>';
            
            db.collection('users').doc(userId).collection('subjects')
                .get()
                .then((querySnapshot) => {
                    selectedUserDiary.innerHTML = '<h3>–î–Ω–µ–≤–Ω–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>';
                    
                    if (querySnapshot.empty) {
                        selectedUserDiary.innerHTML += '<p>–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤.</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const subject = doc.data();
                        const subjectElement = document.createElement('div');
                        subjectElement.className = 'subject-card';
                        
                        const gradesHtml = subject.grades.map(grade => 
                            `<span class="grade-item">${grade}</span>`
                        ).join('');
                        
                        subjectElement.innerHTML = `
                            <div class="subject-header">
                                <div class="subject-title">${subject.name}</div>
                                <div class="subject-average">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${subject.average.toFixed(2)}</div>
                            </div>
                            <div class="grades-list">${gradesHtml}</div>
                        `;
                        
                        selectedUserDiary.appendChild(subjectElement);
                    });
                })
                .catch((error) => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ", error);
                    selectedUserDiary.innerHTML = '<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–Ω–µ–≤–Ω–∏–∫–∞.</p>';
                });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤
        function promptAddGrade(subjectName) {
            const grade = prompt('–í–≤–µ–¥–∏—Ç–µ –æ—Ü–µ–Ω–∫—É (1-5):');
            if (grade && currentUser) {
                const gradeNum = parseInt(grade);
                if (gradeNum >= 1 && gradeNum <= 5) {
                    addGradeToSubject(currentUser.uid, subjectName, gradeNum);
                } else {
                    alert('–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 5');
                }
            }
        }

        function promptEditGrade(subjectName, gradeIndex, currentGrade) {
            const newGrade = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –æ—Ü–µ–Ω–∫—É (1-5):', currentGrade);
            if (newGrade && currentUser) {
                const gradeNum = parseInt(newGrade);
                if (gradeNum >= 1 && gradeNum <= 5) {
                    updateGrade(currentUser.uid, subjectName, gradeIndex, gradeNum);
                } else {
                    alert('–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 5');
                }
            }
        }

        function promptRenameSubject(currentName) {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:', currentName);
            if (newName && newName !== currentName && currentUser) {
                updateSubjectName(currentUser.uid, currentName, newName);
            }
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        auth.onAuthStateChanged((user) => {
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É
                currentUser = user;
                userEmail.textContent = user.email;
                authButtons.style.display = 'none';
                userInfo.style.display = 'flex';
                authContainer.style.display = 'none';
                diaryContainer.style.display = 'block';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
                isAdmin = user.email === 'alway6offline@gmail.com';
                if (isAdmin) {
                    adminTab.style.display = 'block';
                    loadUsersList();
                } else {
                    adminTab.style.display = 'none';
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                loadUserSubjects(user.uid);
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                currentUser = null;
                isAdmin = false;
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
                authContainer.style.display = 'block';
                diaryContainer.style.display = 'none';
                subjectsList.innerHTML = '';
                gradesContent.innerHTML = '';
                usersList.innerHTML = '';
                selectedUserDiary.innerHTML = '';
            }
        });

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ onclick
        window.promptAddGrade = promptAddGrade;
        window.promptEditGrade = promptEditGrade;
        window.promptRenameSubject = promptRenameSubject;
        window.deleteGrade = deleteGrade;
    </script>
</body>
</html>
